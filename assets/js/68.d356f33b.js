(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{637:function(s,t,a){s.exports=a.p+"assets/img/image-20210405215947118.b393bb06.png"},638:function(s,t,a){s.exports=a.p+"assets/img/image-20210405222634095.707b8853.png"},768:function(s,t,a){"use strict";a.r(t);var n=a(13),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"nginx-构建-tomcat-集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-构建-tomcat-集群"}},[s._v("#")]),s._v(" Nginx 构建 Tomcat 集群")]),s._v(" "),n("p",[s._v("在前面是在介绍 Nginx 的用法和基础知识，现在我们要来构建业务集群了")]),s._v(" "),n("p",[n("img",{attrs:{src:a(637),alt:"image-20210405215947118"}})]),s._v(" "),n("p",[s._v("笔者这里的分布如下：")]),s._v(" "),n("ul",[n("li",[s._v("Nginx：192.168.56.105")]),s._v(" "),n("li",[s._v("Tomcat1：192.168.56.106")]),s._v(" "),n("li",[s._v("Tomcat2：192.168.56.107")]),s._v(" "),n("li",[s._v("Tomcat3：192.168.56.108")])]),s._v(" "),n("p",[s._v("这里，我们在原来的 my.conf 中来编写配置文件")]),s._v(" "),n("div",{staticClass:"language-lua line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-lua"}},[n("code",[n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 配置上游服务器"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("名称是自定义的\nupstream "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("tomcats")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".56")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".106")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".56")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".107")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".56")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".108")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("server")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   listen       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server_name  www"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tomcats"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   location "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      proxy_pass    http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("tomcats"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("不要忘记增加 hosts 配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# tomcat 集群\n192.168.56.105 www.tomcats.com\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("访问 "),n("code",[s._v("http://www.tomcats.com/")]),s._v(" 就能访问到集群了")]),s._v(" "),n("p",[s._v("注：proxy_pass 指令后面可以直接写目标地址，这个和 upstream 中只有一个 server 效果是一样的")]),s._v(" "),n("h2",{attrs:{id:"负载均衡策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡策略"}},[s._v("#")]),s._v(" 负载均衡策略")]),s._v(" "),n("h3",{attrs:{id:"轮询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#轮询"}},[s._v("#")]),s._v(" 轮询")]),s._v(" "),n("p",[s._v("Nginx 搭建的 upstream 默认策略是 "),n("strong",[s._v("轮询")]),s._v("，就是一个 server 依次处理一个请求")]),s._v(" "),n("p",[s._v("这种情况下适合每个 server 的硬件配置是一样的（处理能力是一样的）")]),s._v(" "),n("p",[s._v("如何验证呢？现在 3 个 tomcat 的默认首页都是一样的，我们需要 更改它的默认首页信息，才能验证当前访问的到底是哪一个 server")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每个 tomcat 都更改该文件的内容")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/local/tomcat-api/webapps/ROOT/index.jsp \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 body 标签下面增加一行代码，标识当前是哪一个 tomcat")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("body"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("p"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("tomcat"),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v("<")]),s._v("/p"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("每次刷新都会是不同的 tomcat 被访问到")]),s._v(" "),n("h3",{attrs:{id:"加权轮询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#加权轮询"}},[s._v("#")]),s._v(" 加权轮询")]),s._v(" "),n("p",[n("img",{attrs:{src:a(638),alt:"image-20210405222634095"}})]),s._v(" "),n("p",[s._v("如上图所示，根据每个工人的身体素质，分配不同的任务。")]),s._v(" "),n("p",[s._v("在 nginx 中使用 "),n("code",[s._v("weight")]),s._v(" 关键字来指定")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream tomcats {\n   server 192.168.56.106:8080    weight=1;\n   server 192.168.56.107:8080    weight=2;\n   server 192.168.56.108:8080    weight=3;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("这个测试的话，不太明显的能看出来，但是在不断的刷新中，能明显的感觉到 "),n("code",[s._v("weight=3")]),s._v(" 的出现几率较大")]),s._v(" "),n("h2",{attrs:{id:"upstream-指令参数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#upstream-指令参数"}},[s._v("#")]),s._v(" upstream 指令参数")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),n("p",[s._v("本章内容可以在官方文档 "),n("a",{attrs:{href:"http://nginx.org/en/docs/stream/ngx_stream_upstream_module.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("ngx_stream_upstream_module"),n("OutboundLink")],1),s._v(" 找到")]),s._v(" "),n("p",[s._v("要记得：nginx 是由多个模块组合起来的，我们在配置的时候其实就是在针对他的模块配置，所以只要找对应的模块即可")])]),s._v(" "),n("p",[s._v("下面介绍几个常用的参数")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("max_conns")])]),s._v(" "),n("li",[n("p",[s._v("slow_start")])]),s._v(" "),n("li",[n("p",[s._v("down")])]),s._v(" "),n("li",[n("p",[s._v("backup")])]),s._v(" "),n("li",[n("p",[s._v("max_fails")])]),s._v(" "),n("li",[n("p",[s._v("fail_timeout")])])]),s._v(" "),n("h3",{attrs:{id:"max-conns"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#max-conns"}},[s._v("#")]),s._v(" max_conns")]),s._v(" "),n("p",[s._v("限制链接到 server 的最大连接数")]),s._v(" "),n("p",[s._v("需要注意的是：")]),s._v(" "),n("ul",[n("li",[s._v("如果配置了多个 work 进程，则需要共享配置，链接总数就有可能会超过 max_conns 的限制，这里说需要定义在共享内存中，这个也是一个语法，文档中有描述；但是文档中大概意思是说：如果没有定义共享内存，那么这个限制会在每个 worker 进程中独享配置")]),s._v(" "),n("li",[s._v("老版本中没有该参数，原来是给商业版本使用的，在新版本就可以使用了")])]),s._v(" "),n("p",[s._v("如下配置")]),s._v(" "),n("div",{staticClass:"language-lua line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-lua"}},[n("code",[n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 配置上游服务器"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("名称是自定义的\nupstream "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("tomcats")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".56")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".106")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("    max_conns"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".56")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".107")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("    max_conns"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".56")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".108")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("    max_conns"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("当达到最大链接数量时，新增的链接会被拒绝掉，响应 "),n("code",[s._v("502 状态，Bad Gateway")]),s._v(" 信息，这个可以通过 JMeter 来进行测试")])])}),[],!1,null,null,null);t.default=e.exports}}]);